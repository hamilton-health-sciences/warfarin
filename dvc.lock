schema: '2.0'
stages:
  convert_baseline:
    cmd: python3 scripts/convert_sas_to_feather.py --input_filename data/raw_data/merged_baseline.sas7bdat
      --output_filename data/raw_data/baseline.feather
    deps:
    - path: data/raw_data/merged_baseline.sas7bdat
      md5: 0a9c83fa2592b6257ec8328834955183
      size: 93978624
    - path: scripts/convert_sas_to_feather.py
      md5: 692c25ee75e606aff15b529d8a562228
      size: 738
    outs:
    - path: data/raw_data/baseline.feather
      md5: 753fac5aaa8aa27b29643fe32b206506
      size: 31934690
  convert_inr:
    cmd: python3 scripts/convert_sas_to_feather.py --input_filename data/raw_data/merged_inr.sas7bdat
      --output_filename data/raw_data/inr.feather
    deps:
    - path: data/raw_data/merged_inr.sas7bdat
      md5: c1e39f337ef4deacc55eb55dd5e84840
      size: 1338245120
    - path: scripts/convert_sas_to_feather.py
      md5: 692c25ee75e606aff15b529d8a562228
      size: 738
    outs:
    - path: data/raw_data/inr.feather
      md5: 8c0562a1bb26f1fd910582ca7c3f2252
      size: 263391586
  convert_events:
    cmd: python3 scripts/convert_sas_to_feather.py --input_filename data/raw_data/merged_events.sas7bdat
      --output_filename data/raw_data/events.feather
    deps:
    - path: data/raw_data/merged_events.sas7bdat
      md5: 5c071f4777f39678e72fca9c16a69430
      size: 253378560
    - path: scripts/convert_sas_to_feather.py
      md5: 692c25ee75e606aff15b529d8a562228
      size: 738
    outs:
    - path: data/raw_data/events.feather
      md5: 9d4e3405130483184e4d600339851997
      size: 7940194
  preprocess:
    cmd: python3 scripts/preprocess_combine_af.py --baseline_path data/raw_data/baseline.feather
      --inr_path data/raw_data/inr.feather --events_path data/raw_data/events.feather
      --output_directory data/clean_data
    deps:
    - path: data/raw_data/baseline.feather
      md5: 753fac5aaa8aa27b29643fe32b206506
      size: 31934690
    - path: data/raw_data/events.feather
      md5: 9d4e3405130483184e4d600339851997
      size: 7940194
    - path: data/raw_data/inr.feather
      md5: 8c0562a1bb26f1fd910582ca7c3f2252
      size: 263391586
    - path: scripts/preprocess_combine_af.py
      md5: 68d2cceafd46cd788034ca6451d6d458
      size: 5322
    params:
      params.yaml:
        data:
          min_train_trajectory_length: 5
          events_to_keep:
            DEATH: Death
            STROKE: Ischemic Stroke
            MAJOR_BLEED: Major Bleeding
            MINOR_BLEED: Minor Bleeding
            HEM_STROKE: Hemorrhagic Stroke
            HOSP: Hospitalization
            SYS_EMB: Systemic Embolism
          events_to_split:
          - DEATH
          - STROKE
          - MAJOR_BLEED
          - HEM_STROKE
          - HOSP
          - SYS_EMB
          events_to_evaluate:
          - STROKE
          - HEM_STROKE
          - MAJOR_BLEED
          state_columns:
          - AGE_DEIDENTIFIED
          - SEX
          - WEIGHT
          - RACE2
          - CONTINENT
          - SMOKE
          - BMED_ASPIRIN
          - BMED_AMIOD
          - BMED_THIENO
          - DIABETES
          - HX_CHF
          - HYPERTENSION
          - HX_MI
          - INR_VALUE
          - WARFARIN_DOSE
          - STROKE_FLAG
          - MAJOR_BLEED_FLAG
          - MINOR_BLEED_FLAG
          - HEM_STROKE_FLAG
          - HOSP_FLAG
          - WARFARIN_DOSE_BIN
          - AGE_BIN
          - WEIGHT_BIN
        preprocess:
          static_state_columns:
          - SEX
          - RACE2
          - CONTINENT
          - SMOKE
          - BMED_ASPIRIN
          - BMED_AMIOD
          - DIABETES
          - HX_CHF
          - HYPERTENSION
          - HX_MI
          - BMED_THIENO
          - AGE_DEIDENTIFIED
          - WEIGHT
          dose_outlier_threshold: 140
          event_range: 90
          max_time_elapsed: 90
    outs:
    - path: data/auditing/impute_inr_and_dose.feather
      md5: 6223e235d2114d38cb31e2003029277a
      size: 15234810
    - path: data/auditing/merge_inr_baseline.feather
      md5: 8ccb16262299199107165339a384d2ad
      size: 12763138
    - path: data/auditing/merge_inr_events.feather
      md5: 408f7888d17399618a877464b80c4842
      size: 15123922
    - path: data/auditing/merge_trials_and_remove_outlying_doses.feather
      md5: 5f3387e46ef6fb5ea6c4c39621de406f
      size: 17820970
    - path: data/auditing/preprocess_all_baseline.feather
      md5: b27ac9ae4ba65010084eadd4b68715b0
      size: 12117674
    - path: data/auditing/preprocess_all_events.feather
      md5: 8f638d845371ad7e8905f0de7f1e87a0
      size: 3097738
    - path: data/auditing/preprocess_all_inr.feather
      md5: a229bbb3b6f2aedfb4d35f10acb0fb73
      size: 242435994
    - path: data/auditing/preprocess_aristotle.feather
      md5: 2d8df7120c54046eda7e036e9d842cca
      size: 4185610
    - path: data/auditing/preprocess_engage_rocket.feather
      md5: 2529bd33df6c46b1264295dfe10a060e
      size: 7383994
    - path: data/auditing/preprocess_rely.feather
      md5: ae11985f6df89936e27d3767fb7337c3
      size: 3461946
    - path: data/auditing/remove_short_trajectories.feather
      md5: f57279ddf0f4568e85daa22f0c03e404
      size: 12720754
    - path: data/auditing/split_data_test.feather
      md5: 2fe8daa1bea1f121af063f7078453110
      size: 3241330
    - path: data/auditing/split_data_train.feather
      md5: 28f657f5698da59f6a85e98ffe213234
      size: 12123626
    - path: data/auditing/split_data_val.feather
      md5: 1261ea69704efb58e73f903ce211e162
      size: 969994
    - path: data/auditing/split_trajectories_at_events.feather
      md5: 3d247699882b107e9f6d865ddf42dac8
      size: 11710138
    - path: data/auditing/split_trajectories_at_gaps.feather
      md5: 2e90dbb2f19a7ceffc92508d34ed9a4b
      size: 11680218
    - path: data/clean_data/baseline.feather
      md5: 9befc0bfa703ad2065c768f78083b056
      size: 12002450
    - path: data/clean_data/events.feather
      md5: 58fe757b812ad14754e029c38f4771c5
      size: 2842122
    - path: data/clean_data/inr.feather
      md5: 093e2fc30038bdfe560471fde6b98de1
      size: 14296778
    - path: data/clean_data/merged.feather
      md5: f57279ddf0f4568e85daa22f0c03e404
      size: 12720754
    - path: data/clean_data/test_data.feather
      md5: a7250755b725d93b1bcd40c5005e2c59
      size: 2555050
    - path: data/clean_data/train_data.feather
      md5: 512b80a2695d33b0a91c80d0c5c58365
      size: 9444698
    - path: data/clean_data/val_data.feather
      md5: a06428e354e3801114edc2a7f2746b20
      size: 759946
  audit_preprocess:
    cmd: python3 scripts/audit_combine_preprocessing.py > output/combine_preprocess_audit.txt
    deps:
    - path: data/auditing/impute_inr_and_dose.feather
      md5: 6223e235d2114d38cb31e2003029277a
      size: 15234810
    - path: data/auditing/merge_inr_baseline.feather
      md5: 8ccb16262299199107165339a384d2ad
      size: 12763138
    - path: data/auditing/merge_inr_events.feather
      md5: 408f7888d17399618a877464b80c4842
      size: 15123922
    - path: data/auditing/merge_trials_and_remove_outlying_doses.feather
      md5: 5f3387e46ef6fb5ea6c4c39621de406f
      size: 17820970
    - path: data/auditing/preprocess_all_baseline.feather
      md5: b27ac9ae4ba65010084eadd4b68715b0
      size: 12117674
    - path: data/auditing/preprocess_all_events.feather
      md5: 8f638d845371ad7e8905f0de7f1e87a0
      size: 3097738
    - path: data/auditing/preprocess_all_inr.feather
      md5: a229bbb3b6f2aedfb4d35f10acb0fb73
      size: 242435994
    - path: data/auditing/preprocess_aristotle.feather
      md5: 2d8df7120c54046eda7e036e9d842cca
      size: 4185610
    - path: data/auditing/preprocess_engage_rocket.feather
      md5: 2529bd33df6c46b1264295dfe10a060e
      size: 7383994
    - path: data/auditing/preprocess_rely.feather
      md5: ae11985f6df89936e27d3767fb7337c3
      size: 3461946
    - path: data/auditing/remove_short_trajectories.feather
      md5: f57279ddf0f4568e85daa22f0c03e404
      size: 12720754
    - path: data/auditing/split_data_test.feather
      md5: 2fe8daa1bea1f121af063f7078453110
      size: 3241330
    - path: data/auditing/split_data_train.feather
      md5: 28f657f5698da59f6a85e98ffe213234
      size: 12123626
    - path: data/auditing/split_data_val.feather
      md5: 1261ea69704efb58e73f903ce211e162
      size: 969994
    - path: data/auditing/split_trajectories_at_events.feather
      md5: 3d247699882b107e9f6d865ddf42dac8
      size: 11710138
    - path: data/auditing/split_trajectories_at_gaps.feather
      md5: 2e90dbb2f19a7ceffc92508d34ed9a4b
      size: 11680218
    - path: data/clean_data/baseline.feather
      md5: 9befc0bfa703ad2065c768f78083b056
      size: 12002450
    - path: data/clean_data/events.feather
      md5: 58fe757b812ad14754e029c38f4771c5
      size: 2842122
    - path: data/clean_data/inr.feather
      md5: 093e2fc30038bdfe560471fde6b98de1
      size: 14296778
    - path: data/clean_data/merged.feather
      md5: f57279ddf0f4568e85daa22f0c03e404
      size: 12720754
    - path: data/clean_data/test_data.feather
      md5: a7250755b725d93b1bcd40c5005e2c59
      size: 2555050
    - path: data/clean_data/train_data.feather
      md5: 512b80a2695d33b0a91c80d0c5c58365
      size: 9444698
    - path: data/clean_data/val_data.feather
      md5: a06428e354e3801114edc2a7f2746b20
      size: 759946
    - path: scripts/audit_combine_preprocessing.py
      md5: b0d4bc6ff636f54ed09f9b39544e7121
      size: 17748
    params:
      params.yaml:
        data:
          min_train_trajectory_length: 5
          events_to_keep:
            DEATH: Death
            STROKE: Ischemic Stroke
            MAJOR_BLEED: Major Bleeding
            MINOR_BLEED: Minor Bleeding
            HEM_STROKE: Hemorrhagic Stroke
            HOSP: Hospitalization
            SYS_EMB: Systemic Embolism
          events_to_split:
          - DEATH
          - STROKE
          - MAJOR_BLEED
          - HEM_STROKE
          - HOSP
          - SYS_EMB
          events_to_evaluate:
          - STROKE
          - HEM_STROKE
          - MAJOR_BLEED
          state_columns:
          - AGE_DEIDENTIFIED
          - SEX
          - WEIGHT
          - RACE2
          - CONTINENT
          - SMOKE
          - BMED_ASPIRIN
          - BMED_AMIOD
          - BMED_THIENO
          - DIABETES
          - HX_CHF
          - HYPERTENSION
          - HX_MI
          - INR_VALUE
          - WARFARIN_DOSE
          - STROKE_FLAG
          - MAJOR_BLEED_FLAG
          - MINOR_BLEED_FLAG
          - HEM_STROKE_FLAG
          - HOSP_FLAG
          - WARFARIN_DOSE_BIN
          - AGE_BIN
          - WEIGHT_BIN
        preprocess:
          static_state_columns:
          - SEX
          - RACE2
          - CONTINENT
          - SMOKE
          - BMED_ASPIRIN
          - BMED_AMIOD
          - DIABETES
          - HX_CHF
          - HYPERTENSION
          - HX_MI
          - BMED_THIENO
          - AGE_DEIDENTIFIED
          - WEIGHT
          dose_outlier_threshold: 140
          event_range: 90
          max_time_elapsed: 90
    outs:
    - path: data/auditing/dose_change_inr_change_tile.png
      md5: fe8680b9fd4b406a271ede73f3f4f561
      size: 105793
    - path: data/auditing/inr_dose_change_tile.png
      md5: acbd7f4a80610939e6cc143d76a7a8fb
      size: 94738
    - path: output/combine_preprocess_audit.txt
      md5: f4a12e69c4b63c291da6de0d734a2a15
      size: 16941
  testing:
    cmd: echo hello > mygittrackedfile
    deps:
    - path: warfarin/config.py
      md5: 13ceb20ff89d3e17ab705888aa6a4eb5
      size: 4859
    outs:
    - path: mygittrackedfile
      md5: b1946ac92492d2347c6235b4d2611184
      size: 6
  tune_behavior_cloner:
    cmd: python3 scripts/tune_bc.py
    deps:
    - path: data/clean_data/train_data.feather
      md5: 512b80a2695d33b0a91c80d0c5c58365
      size: 9444698
    - path: data/clean_data/val_data.feather
      md5: a06428e354e3801114edc2a7f2746b20
      size: 759946
    - path: scripts/tune_bc.py
      md5: a847d9e2784f7c603322bbed974f274d
      size: 6272
    params:
      params.yaml:
        behavior_cloner:
          tune_seed: 42
          min_training_epochs: 100
          max_training_epochs: 500
          target_metric: val/auroc
          target_mode: max
          hyperparams:
            init_seed:
            - 0
            likelihood:
            - discrete
            learning_rate:
            - 0.0001
            batch_size:
            - 16
            num_layers:
            - 2
            - 3
            hidden_dim:
            - 16
            - 128
            weight_option_frequency:
            - false
        data.events_to_keep:
          DEATH: Death
          STROKE: Ischemic Stroke
          MAJOR_BLEED: Major Bleeding
          MINOR_BLEED: Minor Bleeding
          HEM_STROKE: Hemorrhagic Stroke
          HOSP: Hospitalization
          SYS_EMB: Systemic Embolism
        data.events_to_split:
        - DEATH
        - STROKE
        - MAJOR_BLEED
        - HEM_STROKE
        - HOSP
        - SYS_EMB
        data.min_train_trajectory_length: 5
        data.state_columns:
        - AGE_DEIDENTIFIED
        - SEX
        - WEIGHT
        - RACE2
        - CONTINENT
        - SMOKE
        - BMED_ASPIRIN
        - BMED_AMIOD
        - BMED_THIENO
        - DIABETES
        - HX_CHF
        - HYPERTENSION
        - HX_MI
        - INR_VALUE
        - WARFARIN_DOSE
        - STROKE_FLAG
        - MAJOR_BLEED_FLAG
        - MINOR_BLEED_FLAG
        - HEM_STROKE_FLAG
        - HOSP_FLAG
        - WARFARIN_DOSE_BIN
        - AGE_BIN
        - WEIGHT_BIN
        replay_buffer.init.include_dose_time_varying: true
        replay_buffer.init.time_varying: across
    outs:
    - path: ray_logs/bc
      md5: 75dac90ade96687403c2137c5506976a.dir
      size: 6767764781
      nfiles: 6038
  select_behavior_cloner:
    cmd: python3 scripts/choose_bc.py
    deps:
    - path: data/clean_data/train_data.feather
      md5: 512b80a2695d33b0a91c80d0c5c58365
      size: 9444698
    - path: data/clean_data/val_data.feather
      md5: a06428e354e3801114edc2a7f2746b20
      size: 759946
    - path: scripts/choose_bc.py
      md5: b95381a99ccc7b6c823927c6d83a19b8
      size: 5416
    params:
      params.yaml:
        behavior_cloner:
          tune_seed: 42
          min_training_epochs: 100
          max_training_epochs: 500
          target_metric: val/auroc
          target_mode: max
          hyperparams:
            init_seed:
            - 0
            likelihood:
            - discrete
            learning_rate:
            - 0.0001
            batch_size:
            - 16
            num_layers:
            - 2
            - 3
            hidden_dim:
            - 16
            - 128
            weight_option_frequency:
            - false
    outs:
    - path: output/behavior_cloner_wis
      md5: 0a04c267cdc8206cb3944a1db0c14f54.dir
      size: 340863
      nfiles: 4
  tune_dsbcq:
    cmd: python3 scripts/tune_smdp_dbcq.py
    deps:
    - path: data/clean_data/train_data.feather
      md5: 512b80a2695d33b0a91c80d0c5c58365
      size: 9444698
    - path: data/clean_data/val_data.feather
      md5: a06428e354e3801114edc2a7f2746b20
      size: 759946
    - path: scripts/tune_smdp_dbcq.py
      md5: ea4feca36be2263ff2f729a52179c749
      size: 12167
    params:
      params.yaml:
        data.events_to_keep:
          DEATH: Death
          STROKE: Ischemic Stroke
          MAJOR_BLEED: Major Bleeding
          MINOR_BLEED: Minor Bleeding
          HEM_STROKE: Hemorrhagic Stroke
          HOSP: Hospitalization
          SYS_EMB: Systemic Embolism
        data.events_to_split:
        - DEATH
        - STROKE
        - MAJOR_BLEED
        - HEM_STROKE
        - HOSP
        - SYS_EMB
        data.min_train_trajectory_length: 5
        data.state_columns:
        - AGE_DEIDENTIFIED
        - SEX
        - WEIGHT
        - RACE2
        - CONTINENT
        - SMOKE
        - BMED_ASPIRIN
        - BMED_AMIOD
        - BMED_THIENO
        - DIABETES
        - HX_CHF
        - HYPERTENSION
        - HX_MI
        - INR_VALUE
        - WARFARIN_DOSE
        - STROKE_FLAG
        - MAJOR_BLEED_FLAG
        - MINOR_BLEED_FLAG
        - HEM_STROKE_FLAG
        - HOSP_FLAG
        - WARFARIN_DOSE_BIN
        - AGE_BIN
        - WEIGHT_BIN
        dsbcq:
          tune_seed: 43
          min_training_epochs: 50
          max_training_epochs: 500
          plot_every: 50
          target_metric: val/wis/policy_value
          target_mode: max
          hyperparams:
            init_seed:
            - 1
            - 2
            - 3
            bcq_threshold:
            - 0.2
            - 0.3
            batch_size:
            - 32
            num_layers:
            - 3
            hidden_dim:
            - 128
            learning_rate:
            - 1e-06
            tau:
            - 0.005
        replay_buffer.init.include_dose_time_varying: true
        replay_buffer.init.time_varying: across
    outs:
    - path: ray_logs/dbcq
      md5: 9812a592475a8f747b4beb05b31be3e5.dir
      size: 11758488440
      nfiles: 9056
  evaluate:
    cmd: bash scripts/evaluate.sh
    deps:
    - path: data/clean_data/events.feather
      md5: 58fe757b812ad14754e029c38f4771c5
      size: 2842122
    - path: data/clean_data/test_data.feather
      md5: a7250755b725d93b1bcd40c5005e2c59
      size: 2555050
    - path: data/clean_data/train_data.feather
      md5: 512b80a2695d33b0a91c80d0c5c58365
      size: 9444698
    - path: data/raw_data/drugs_rely.csv
      md5: 9d8088afd39fdf44d6c54d49fa7e5851
      size: 1738287
    - path: data/raw_data/ittr_baseline.csv
      md5: 35b53b71724cb92501546bb62e8f098f
      size: 14072003
    - path: data/raw_data/rely_subjids.sas7bdat
      md5: adf0ee5c7ee062df7971cf955549f043
      size: 1245184
    - path: data/raw_data/sas_libs
      md5: d790633fbd24af8d5fc4ad5d988e2dd0.dir
      size: 4068230230
      nfiles: 717
    - path: ray_logs/dbcq
      md5: 9812a592475a8f747b4beb05b31be3e5.dir
      size: 11758488440
      nfiles: 9056
    params:
      params.yaml:
        dsbcq:
          tune_seed: 43
          min_training_epochs: 50
          max_training_epochs: 500
          plot_every: 50
          target_metric: val/wis/policy_value
          target_mode: max
          hyperparams:
            init_seed:
            - 1
            - 2
            - 3
            bcq_threshold:
            - 0.2
            - 0.3
            batch_size:
            - 32
            num_layers:
            - 3
            hidden_dim:
            - 128
            learning_rate:
            - 1e-06
            tau:
            - 0.005
        replay_buffer.init.include_dose_time_varying: true
        replay_buffer.init.time_varying: across
